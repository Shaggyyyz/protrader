<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Trader Dashboard</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #050505; 
            color: #e5e7eb; 
        }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0e0e0e; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        /* Animations */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .spin-slow { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- HEADER -->
    <header class="h-16 border-b border-gray-800 flex items-center justify-between px-4 md:px-8 bg-black/80 backdrop-blur-md sticky top-0 z-50">
        <div class="flex items-center gap-8">
            <div class="flex items-center gap-2 cursor-pointer" onclick="app.setView('dashboard')">
                <div class="w-8 h-8 bg-blue-600 rounded flex items-center justify-center font-bold text-xs text-white shadow-lg shadow-blue-900/20">PT</div>
                <span class="font-bold text-xl tracking-tight text-white">PRO<span class="text-blue-500">TRADER</span></span>
            </div>
            <nav class="hidden md:flex gap-1 bg-gray-900/50 p-1 rounded-lg border border-gray-800">
                <button id="nav-dashboard" onclick="app.setView('dashboard')" class="px-4 py-1.5 rounded text-xs font-bold transition-all text-white bg-gray-800">SCANNER</button>
                <button id="nav-portfolio" onclick="app.setView('portfolio')" class="px-4 py-1.5 rounded text-xs font-bold transition-all text-gray-500 hover:text-white">PORTFOLIO</button>
            </nav>
        </div>
        
        <div class="flex items-center gap-4">
             <div class="hidden md:block text-right">
                <div class="text-[10px] text-gray-500 uppercase font-bold tracking-wider">Last Update</div>
                <div id="last-updated" class="text-xs font-mono font-bold text-white">--:--:--</div>
             </div>
             <div class="flex flex-col items-end">
                 <button id="refresh-btn" onclick="app.handleRefresh()" class="flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold rounded transition-all shadow-lg shadow-blue-900/20 active:scale-95">
                    <i data-lucide="refresh-cw" class="w-3 h-3"></i> 
                    <span id="refresh-text">REFRESH DATA</span>
                 </button>
                 <div class="text-[9px] mt-1 text-gray-600 flex items-center gap-1 font-mono">
                    API: <span id="api-status" class="text-orange-500">OFFLINE (CACHED)</span>
                 </div>
             </div>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main id="root" class="flex-1 p-4 md:p-8 max-w-7xl mx-auto w-full">
        <!-- Dynamic Content Injected Here -->
    </main>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- CONFIGURATION ---
        const MARKETSTACK_KEY = '29f6e55e359cea3c32dfb279a4901516'; 
        const MARKETSTACK_BASE_URL = 'http://api.marketstack.com/v2'; // Free tier is HTTP

        const BASE_POOL = [
            { symbol: 'SPY', name: 'S&P 500 ETF', type: 'index', price: 679.68, ath: 689.70, volatility: 0.012, marketCap: 613, alwaysShow: true }, 
            { symbol: 'BTC', name: 'Bitcoin', type: 'crypto', price: 91316.66, ath: 126080.00, volatility: 0.045, marketCap: 1800, alwaysShow: true },
            { symbol: 'XAU', name: 'Gold', type: 'commodity', price: 4162.90, ath: 4250.00, volatility: 0.008, marketCap: 18000, alwaysShow: true },
            { symbol: 'NVDA', name: 'NVIDIA Corp', type: 'stock', price: 182.55, ath: 212.19, volatility: 0.035, marketCap: 4321 },
            { symbol: 'AAPL', name: 'Apple Inc', type: 'stock', price: 277.55, ath: 280.38, volatility: 0.015, marketCap: 4100 },
            { symbol: 'GOOGL', name: 'Alphabet', type: 'stock', price: 319.95, ath: 328.83, volatility: 0.020, marketCap: 3860 },
            { symbol: 'MSFT', name: 'Microsoft', type: 'stock', price: 476.99, ath: 555.45, volatility: 0.018, marketCap: 3520 },
            { symbol: 'AMZN', name: 'Amazon', type: 'stock', price: 229.51, ath: 258.60, volatility: 0.022, marketCap: 2450 },
            { symbol: 'AVGO', name: 'Broadcom', type: 'stock', price: 385.03, ath: 399.87, volatility: 0.025, marketCap: 1880 },
            { symbol: 'META', name: 'Meta Platforms', type: 'stock', price: 635.80, ath: 796.25, volatility: 0.030, marketCap: 1600 },
            { symbol: 'TSLA', name: 'Tesla Inc', type: 'stock', price: 419.10, ath: 488.54, volatility: 0.050, marketCap: 1420 },
            { symbol: 'BRK.B', name: 'Berkshire Hath', type: 'stock', price: 508.60, ath: 542.07, volatility: 0.010, marketCap: 1110 },
            { symbol: 'LLY', name: 'Eli Lilly', type: 'stock', price: 1103.27, ath: 1118.00, volatility: 0.015, marketCap: 1040 },
            { symbol: 'WMT', name: 'Walmart', type: 'stock', price: 106.07, ath: 109.59, volatility: 0.010, marketCap: 870 },
            { symbol: 'JPM', name: 'JPMorgan Chase', type: 'stock', price: 298.56, ath: 300.00, volatility: 0.012, marketCap: 837 },
            { symbol: 'V', name: 'Visa', type: 'stock', price: 315.00, ath: 320.00, volatility: 0.011, marketCap: 627 },
            { symbol: 'MA', name: 'Mastercard', type: 'stock', price: 520.00, ath: 530.00, volatility: 0.012, marketCap: 480 },
            { symbol: 'BAC', name: 'Bank of America', type: 'stock', price: 46.50, ath: 55.00, volatility: 0.015, marketCap: 360 },
            { symbol: 'UNH', name: 'UnitedHealth', type: 'stock', price: 580.00, ath: 600.00, volatility: 0.012, marketCap: 530 },
            { symbol: 'JNJ', name: 'Johnson & Johnson', type: 'stock', price: 155.00, ath: 175.00, volatility: 0.010, marketCap: 370 },
            { symbol: 'MRK', name: 'Merck & Co', type: 'stock', price: 105.00, ath: 130.00, volatility: 0.012, marketCap: 260 },
            { symbol: 'ABBV', name: 'AbbVie', type: 'stock', price: 195.00, ath: 200.00, volatility: 0.013, marketCap: 340 },
            { symbol: 'COST', name: 'Costco', type: 'stock', price: 940.00, ath: 960.00, volatility: 0.015, marketCap: 420 },
            { symbol: 'PG', name: 'Procter & Gamble', type: 'stock', price: 175.00, ath: 180.00, volatility: 0.008, marketCap: 410 },
            { symbol: 'HD', name: 'Home Depot', type: 'stock', price: 410.00, ath: 420.00, volatility: 0.014, marketCap: 400 },
            { symbol: 'KO', name: 'Coca-Cola', type: 'stock', price: 68.00, ath: 72.00, volatility: 0.008, marketCap: 290 },
            { symbol: 'PEP', name: 'PepsiCo', type: 'stock', price: 165.00, ath: 180.00, volatility: 0.009, marketCap: 230 },
            { symbol: 'XOM', name: 'Exxon Mobil', type: 'stock', price: 114.51, ath: 121.88, volatility: 0.014, marketCap: 482 },
            { symbol: 'CVX', name: 'Chevron', type: 'stock', price: 155.00, ath: 170.00, volatility: 0.015, marketCap: 280 },
            { symbol: 'PLTR', name: 'Palantir', type: 'stock', price: 165.77, ath: 207.52, volatility: 0.060, marketCap: 391 }, 
            { symbol: 'COIN', name: 'Coinbase', type: 'stock', price: 265.03, ath: 444.65, volatility: 0.070, marketCap: 71 },
            { symbol: 'NFLX', name: 'Netflix', type: 'stock', price: 890.00, ath: 900.00, volatility: 0.025, marketCap: 380 },
            { symbol: 'AMD', name: 'AMD', type: 'stock', price: 145.00, ath: 220.00, volatility: 0.040, marketCap: 235 },
            { symbol: 'CRM', name: 'Salesforce', type: 'stock', price: 330.00, ath: 340.00, volatility: 0.020, marketCap: 320 },
            { symbol: 'ORCL', name: 'Oracle', type: 'stock', price: 185.00, ath: 195.00, volatility: 0.018, marketCap: 510 },
            { symbol: 'ADBE', name: 'Adobe', type: 'stock', price: 520.00, ath: 600.00, volatility: 0.022, marketCap: 230 },
            { symbol: 'DIS', name: 'Disney', type: 'stock', price: 115.00, ath: 125.00, volatility: 0.018, marketCap: 210 },
            { symbol: 'NKE', name: 'Nike', type: 'stock', price: 85.00, ath: 100.00, volatility: 0.015, marketCap: 130 },
            { symbol: 'INTC', name: 'Intel', type: 'stock', price: 24.00, ath: 50.00, volatility: 0.030, marketCap: 100 },
            { symbol: 'TMO', name: 'Thermo Fisher', type: 'stock', price: 580.00, ath: 620.00, volatility: 0.012, marketCap: 220 },
            { symbol: 'ABT', name: 'Abbott Labs', type: 'stock', price: 115.00, ath: 120.00, volatility: 0.010, marketCap: 200 },
            { symbol: 'CMCSA', name: 'Comcast', type: 'stock', price: 42.00, ath: 48.00, volatility: 0.012, marketCap: 165 },
            { symbol: 'VZ', name: 'Verizon', type: 'stock', price: 44.00, ath: 45.00, volatility: 0.008, marketCap: 185 },
            { symbol: 'PFE', name: 'Pfizer', type: 'stock', price: 28.00, ath: 35.00, volatility: 0.012, marketCap: 158 },
            { symbol: 'CSCO', name: 'Cisco', type: 'stock', price: 58.00, ath: 60.00, volatility: 0.010, marketCap: 230 },
            { symbol: 'ACN', name: 'Accenture', type: 'stock', price: 360.00, ath: 380.00, volatility: 0.015, marketCap: 225 },
            { symbol: 'MCD', name: 'McDonalds', type: 'stock', price: 300.00, ath: 310.00, volatility: 0.010, marketCap: 215 },
            { symbol: 'DHR', name: 'Danaher', type: 'stock', price: 270.00, ath: 280.00, volatility: 0.014, marketCap: 200 },
            { symbol: 'LIN', name: 'Linde', type: 'stock', price: 460.00, ath: 480.00, volatility: 0.012, marketCap: 220 }
        ];

        // --- APP STATE ---
        let state = {
            allAssets: [],
            vix: 17.19,
            fearGreed: { value: 18, status: 'Extreme Fear' },
            selectedAsset: null,
            view: 'dashboard',
            isRefreshing: false,
            lastUpdated: new Date(),
            sortConfig: { key: null, direction: 'asc' },
            strategy: 'hybrid',
            apiStatus: 'OFFLINE (CACHED)',
            portfolio: JSON.parse(localStorage.getItem('proTraderPortfolio')) || []
        };

        // --- UTILS ---
        const formatCurrency = (val) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 2 }).format(val);
        const formatMarketCap = (val) => val >= 1000 ? `$${(val / 1000).toFixed(2)} T` : `$${val.toFixed(2)} B`;
        const formatDate = (daysAgo) => {
            const date = new Date();
            date.setDate(date.getDate() - daysAgo);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        };

        // --- CHART DATA GENERATOR ---
        function generateHistoryFromPrice(currentPrice, volatility, days = 90) {
            let candles = [];
            let price = currentPrice;
            for (let i = 0; i < days; i++) {
                const changePercent = (Math.random() - 0.48) * (volatility * 1.5); 
                const move = price * changePercent;
                const close = price;
                const open = price - move; 
                const bodyMax = Math.max(open, close);
                const bodyMin = Math.min(open, close);
                const high = bodyMax + (Math.random() * (price * 0.01));
                const low = bodyMin - (Math.random() * (price * 0.01));
                candles.push({ day: days - 1 - i, date: formatDate(i), open, high, low, close });
                price = open; 
            }
            return candles.reverse();
        }

        // --- INDICATORS ---
        function calculateRSI(candles, period = 14) {
            if (!candles || candles.length < period + 1) return 50;
            let gains = 0, losses = 0;
            const len = candles.length;
            for (let i = 0; i < period; i++) {
                const current = candles[len - 1 - i];
                const prev = candles[len - 2 - i];
                if(!current || !prev) continue;
                const change = current.close - prev.close;
                if (change >= 0) gains += change; else losses += Math.abs(change);
            }
            let avgGain = gains / period;
            let avgLoss = losses / period;
            const rs = avgLoss === 0 ? 100 : avgGain / avgLoss;
            return 100 - (100 / (1 + rs));
        }

        function calculateRiskReward(asset, currentVix) {
            const pctDown = ((asset.ath - asset.price) / asset.ath) * 100;
            const rsi = calculateRSI(asset.candles);
            let score = 50;
            let signal = 'HOLD';
            let color = 'text-gray-400';
            let bg = 'bg-gray-800';

            if (pctDown >= 5 && pctDown < 10) score += 5;
            if (pctDown >= 10 && pctDown < 15) score += 10;
            if (pctDown >= 15 && pctDown < 20) score += 15;
            if (pctDown >= 20 && pctDown < 25) score += 25;
            if (pctDown >= 25 && pctDown < 30) score += 35;
            if (pctDown >= 30 && pctDown < 35) score += 45;
            if (pctDown >= 35 && pctDown < 40) score += 55;
            if (pctDown >= 40 && pctDown < 45) score += 65;
            if (pctDown >= 50) score += 80; 

            if (rsi < 30) score += 20;     
            if (rsi < 40) score += 10;
            if (currentVix > 20) score += 10;

            if (score >= 85) { signal = 'STRONG BUY'; color = 'text-green-400'; bg = 'bg-green-900/40 border-green-500'; }
            else if (score >= 70) { signal = 'ACCUMULATE'; color = 'text-green-300'; bg = 'bg-green-900/20 border-green-800'; }
            else if (score <= 30) { signal = 'WAIT'; color = 'text-yellow-500'; bg = 'bg-yellow-900/20 border-yellow-700'; } 
            else if (score >= 60) { signal = 'WATCH'; color = 'text-blue-400'; bg = 'bg-blue-900/20 border-blue-800'; }
            
            return { signal, color, bg, score, rsi };
        }

        // --- INITIALIZATION ---
        const init = () => {
            // Load Base Data (No API Call initially)
            state.allAssets = BASE_POOL.map(base => ({
                ...base,
                candles: generateHistoryFromPrice(base.price, base.volatility, 90)
            }));
            render();
        };

        // --- CORE FUNCTIONS ---
        
        function updateState(newState) {
            Object.assign(state, newState);
            render();
        }
        
        function getSortedAssets() {
            const indices = state.allAssets.filter(a => a.alwaysShow);
            const stocks = state.allAssets.filter(a => !a.alwaysShow && a.type === 'stock');
            let ranked = [];

            if (state.strategy === 'hybrid') {
                ranked = stocks.map(s => ({
                    ...s,
                    score: s.marketCap * (Math.max(((s.ath - s.price)/s.ath)*100, 0) + 5)
                })).sort((a, b) => b.score - a.score);
            } else if (state.strategy === 'marketCap') {
                ranked = stocks.sort((a, b) => b.marketCap - a.marketCap);
            } else if (state.strategy === 'drawdown') {
                ranked = stocks.sort((a, b) => ((b.ath - b.price)/b.ath) - ((a.ath - a.price)/a.ath));
            } else if (state.strategy === 'action') {
                ranked = stocks.sort((a, b) => b.volatility - a.volatility);
            }

            let combined = [...indices, ...ranked.slice(0, 15)];

            if (state.sortConfig.key) {
                combined.sort((a, b) => {
                    let aVal, bVal;
                    if(state.sortConfig.key === 'pctDown') {
                        aVal = ((a.ath - a.price)/a.ath); bVal = ((b.ath - b.price)/b.ath);
                    } else if(state.sortConfig.key === 'rsi') {
                        aVal = calculateRiskReward(a, state.vix).rsi;
                        bVal = calculateRiskReward(b, state.vix).rsi;
                    } else {
                        aVal = a[state.sortConfig.key]; bVal = b[state.sortConfig.key];
                    }
                    if (aVal < bVal) return state.sortConfig.direction === 'asc' ? -1 : 1;
                    if (aVal > bVal) return state.sortConfig.direction === 'asc' ? 1 : -1;
                    return 0;
                });
            }
            return combined;
        }

        async function fetchData() {
            updateState({ isRefreshing: true, apiStatus: 'FETCHING...' });
            
            try {
                const btcRes = await fetch('https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&ids=bitcoin');
                const btcData = await btcRes.json();
                const realBtc = btcData[0] ? { price: btcData[0].current_price, ath: btcData[0].ath, marketCap: btcData[0].market_cap/1e9 } : null;

                const symbols = BASE_POOL.filter(a => a.type === 'stock').map(a => a.symbol).join(',');
                let marketstackData = [];
                let tickersData = [];
                
                try {
                    const [eodRes, tickerRes] = await Promise.all([
                        fetch(`${MARKETSTACK_BASE_URL}/eod?access_key=${MARKETSTACK_KEY}&symbols=${symbols}&limit=100`),
                        fetch(`${MARKETSTACK_BASE_URL}/tickers?access_key=${MARKETSTACK_KEY}&symbols=${symbols}&limit=100`)
                    ]);
                    
                    if (eodRes.ok) {
                        const eodJson = await eodRes.json();
                        marketstackData = eodJson.data || [];
                        state.apiStatus = 'ONLINE (V2)';
                    } else {
                        state.apiStatus = 'OFFLINE (API ERROR)';
                    }
                    
                    if (tickerRes.ok) {
                        const tickerJson = await tickerRes.json();
                        tickersData = tickerJson.data || [];
                    }
                } catch(e) {
                    console.warn("Marketstack error:", e);
                    state.apiStatus = 'OFFLINE (MIXED CONTENT)';
                }

                const newAssets = state.allAssets.map(asset => {
                    let freshPrice = asset.price;
                    let freshMC = asset.marketCap;
                    let freshName = asset.name;
                    let freshATH = asset.ath;

                    if(asset.symbol === 'BTC' && realBtc) {
                        freshPrice = realBtc.price;
                        freshMC = realBtc.marketCap;
                        freshATH = realBtc.ath;
                    }

                    const apiStock = marketstackData.find(i => i.symbol === asset.symbol);
                    if (apiStock) {
                        freshPrice = apiStock.close;
                        const baseAsset = BASE_POOL.find(b => b.symbol === asset.symbol);
                        if(baseAsset) {
                            freshMC = baseAsset.marketCap * (freshPrice / baseAsset.price);
                        }
                        if(freshPrice > freshATH) freshATH = freshPrice;
                    }
                    
                    const apiTicker = tickersData.find(i => i.symbol === asset.symbol);
                    if(apiTicker) freshName = apiTicker.name;

                    let newCandles = asset.candles;
                    if(freshPrice !== asset.price) {
                         newCandles = [...asset.candles];
                         const last = newCandles[newCandles.length - 1];
                         newCandles[newCandles.length - 1] = {
                             ...last,
                             close: freshPrice,
                             high: Math.max(last.high, freshPrice),
                             low: Math.min(last.low, freshPrice)
                         };
                    }

                    return { ...asset, price: freshPrice, marketCap: freshMC, name: freshName, ath: freshATH, candles: newCandles };
                });

                updateState({ allAssets: newAssets, lastUpdated: new Date(), isRefreshing: false });

            } catch (err) {
                console.error(err);
                updateState({ isRefreshing: false, apiStatus: 'ERROR' });
            }
        }

        // --- RENDERERS ---

        function renderCandleChartSVG(data, width) {
            if(!data || data.length === 0) return '';
            const height = 300, padding = 20;
            const allHighs = data.map(d => d.high);
            const allLows = data.map(d => d.low);
            const maxPrice = Math.max(...allHighs);
            const minPrice = Math.min(...allLows);
            const priceRange = maxPrice - minPrice || 1;
            const candleWidth = (width - (padding * 2)) / data.length;
            const barWidth = Math.max(1, candleWidth * 0.6);
            
            const getY = (p) => height - padding - ((p - minPrice) / priceRange) * (height - (padding * 2));
            const getX = (i) => padding + (i * candleWidth);

            let paths = '';
            data.forEach((c, i) => {
                const x = getX(i);
                const color = c.close >= c.open ? '#22c55e' : '#ef4444';
                const wickX = x + barWidth / 2;
                let bodyH = Math.abs(getY(c.close) - getY(c.open));
                if(bodyH < 1) bodyH = 1;
                const bodyY = Math.min(getY(c.open), getY(c.close));
                paths += `<line x1="${wickX}" y1="${getY(c.high)}" x2="${wickX}" y2="${getY(c.low)}" stroke="${color}" stroke-width="1"></line>`;
                paths += `<rect x="${x}" y="${bodyY}" width="${barWidth}" height="${bodyH}" fill="${color}"></rect>`;
            });
            
            return `
                <div class="w-full h-[350px] bg-[#0e0e0e] rounded-lg border border-gray-800 relative select-none group">
                  <div class="absolute right-2 top-2 text-xs text-gray-500">${formatCurrency(maxPrice)}</div>
                  <div class="absolute right-2 bottom-2 text-xs text-gray-500">${formatCurrency(minPrice)}</div>
                  <svg width="100%" height="100%" class="overflow-visible">${paths}</svg>
                </div>
            `;
        }

        function renderDashboard() {
            const assets = getSortedAssets();
            const rows = assets.map(asset => {
                const analysis = calculateRiskReward(asset, state.vix);
                const pctDown = ((asset.ath - asset.price) / asset.ath) * 100;
                const isGreen = asset.price >= asset.candles[asset.candles.length-2].close;
                return `
                <tr class="border-b border-gray-800 hover:bg-[#111] cursor-pointer transition-colors" onclick="app.selectAsset('${asset.symbol}')">
                    <td class="p-4 font-bold text-white flex items-center gap-3">
                        <div class="w-1 h-8 ${analysis.color.replace('text-', 'bg-')} rounded-full"></div>
                        <div><div class="text-base font-bold text-gray-100">${asset.symbol}</div><div class="text-[10px] text-gray-500 font-normal uppercase tracking-wider">${asset.name}</div></div>
                    </td>
                    <td class="p-4 text-right font-mono text-base ${isGreen ? 'text-green-400' : 'text-red-400'}">${formatCurrency(asset.price)}</td>
                    <td class="p-4 text-right text-gray-400 font-mono text-sm hidden sm:table-cell">${formatMarketCap(asset.marketCap)}</td>
                    <td class="p-4 text-right font-bold text-white hidden md:table-cell"><span class="text-xs px-2 py-1 rounded border ${pctDown > 10 ? 'border-red-900 bg-red-900/20 text-red-400' : 'border-gray-700 bg-gray-800'}">-${pctDown.toFixed(2)}%</span></td>
                    <td class="p-4 text-center font-mono text-sm"><span class="${analysis.rsi < 30 ? 'text-green-400 font-bold' : analysis.rsi > 70 ? 'text-red-400 font-bold' : 'text-gray-500'}">${analysis.rsi.toFixed(0)}</span></td>
                    <td class="p-4 text-center"><span class="text-[10px] font-bold px-3 py-1 rounded-full border ${analysis.color} ${analysis.bg}">${analysis.signal}</span></td>
                </tr>`;
            }).join('');

            return `
                <div class="space-y-6 fade-in">
                    ${renderMarketPulse()}
                    ${renderStrategySelector()}
                    <div class="bg-[#0e0e0e] border border-gray-800 rounded-xl overflow-hidden shadow-2xl">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse">
                                <thead>
                                    <tr class="text-gray-500 text-xs uppercase border-b border-gray-800 bg-[#0a0a0a]">
                                        <th class="p-4 cursor-pointer hover:text-white" onclick="app.setSort('symbol')">Asset</th>
                                        <th class="p-4 text-right cursor-pointer hover:text-white" onclick="app.setSort('price')">Price</th>
                                        <th class="p-4 text-right hidden sm:table-cell cursor-pointer hover:text-white" onclick="app.setSort('marketCap')">Mkt Cap</th>
                                        <th class="p-4 text-right hidden md:table-cell cursor-pointer hover:text-white" onclick="app.setSort('pctDown')">% Down</th>
                                        <th class="p-4 text-center cursor-pointer hover:text-white" onclick="app.setSort('rsi')">RSI (14)</th>
                                        <th class="p-4 text-center">Action</th>
                                    </tr>
                                </thead>
                                <tbody>${rows}</tbody>
                            </table>
                        </div>
                        ${renderAlgoLegend()}
                    </div>
                </div>
            `;
        }

        function renderMarketPulse() {
            const fg = state.fearGreed;
            let fgColor = fg.value < 25 ? 'text-red-500' : fg.value < 45 ? 'text-orange-400' : fg.value > 75 ? 'text-green-500' : 'text-green-300';
            return `
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="bg-[#0e0e0e] border border-gray-800 p-5 rounded-xl flex flex-col justify-between relative overflow-hidden">
                     <div class="relative z-10">
                         <h3 class="text-gray-500 text-xs font-bold uppercase flex items-center gap-2"><i data-lucide="gauge" class="w-4 h-4"></i> Fear & Greed</h3>
                         <div class="text-3xl font-black mt-1 ${fgColor}">${fg.value}</div>
                         <div class="text-xs text-gray-400 font-medium mt-1">${fg.status}</div>
                     </div>
                     <div class="absolute right-0 top-0 w-32 h-full bg-gradient-to-l from-gray-900 to-transparent pointer-events-none"></div>
                </div>
                <div class="bg-[#0e0e0e] border border-gray-800 p-5 rounded-xl">
                    <h3 class="text-gray-500 text-xs font-bold uppercase flex items-center gap-2"><i data-lucide="activity" class="w-4 h-4"></i> VIX Index</h3>
                    <div class="text-3xl font-black mt-1 ${state.vix > 20 ? 'text-red-500' : 'text-blue-400'}">${state.vix.toFixed(2)}</div>
                    <div class="text-xs text-gray-500 mt-1">${state.vix > 20 ? "High Volatility Environment" : "Stable Market Conditions"}</div>
                </div>
                <div class="bg-[#0e0e0e] border border-gray-800 p-5 rounded-xl">
                    <h3 class="text-gray-500 text-xs font-bold uppercase flex items-center gap-2"><i data-lucide="zap" class="w-4 h-4 text-yellow-400"></i> Algo Insight</h3>
                    <div class="text-sm text-gray-300 mt-2 leading-relaxed">Current market fear suggests a potential <strong>accumulation phase</strong> for high-quality assets.</div>
                </div>
            </div>`;
        }

        function renderStrategySelector() {
             const strategies = [
                 { id: 'hybrid', label: 'Hybrid Value', icon: 'layers' },
                 { id: 'marketCap', label: 'Market Cap', icon: 'dollar-sign' },
                 { id: 'drawdown', label: 'Deep Value', icon: 'trending-down' },
                 { id: 'action', label: 'High Action', icon: 'activity' }
             ];
             return `
             <div class="flex flex-wrap gap-2 p-1 bg-[#0e0e0e] border border-gray-800 rounded-lg w-fit">
                ${strategies.map(s => `
                    <button onclick="app.setStrategy('${s.id}')" class="px-3 py-1.5 text-xs font-bold rounded flex items-center gap-2 transition-all ${state.strategy === s.id ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/50' : 'text-gray-500 hover:text-white'}">
                        <i data-lucide="${s.icon}" class="w-3 h-3"></i> ${s.label}
                    </button>
                `).join('')}
             </div>`;
        }

        function renderAlgoLegend() {
            return `
            <div class="p-5 grid grid-cols-1 md:grid-cols-3 gap-4 text-xs border-t border-gray-800 bg-[#0a0a0a]">
                 <div class="flex items-start gap-3">
                    <div class="w-2 h-2 mt-1 bg-green-500 rounded-full shadow-[0_0_8px_#22c55e]"></div>
                    <div><div class="font-bold text-green-400">STRONG BUY / ACCUMULATE</div><div class="text-gray-500 leading-tight mt-1">Asset is >20% below ATH with Oversold RSI (<30).</div></div>
                 </div>
                 <div class="flex items-start gap-3">
                    <div class="w-2 h-2 mt-1 bg-blue-500 rounded-full"></div>
                    <div><div class="font-bold text-blue-400">WATCH</div><div class="text-gray-500 leading-tight mt-1">Asset is showing stability or moderate value.</div></div>
                 </div>
                 <div class="flex items-start gap-3">
                    <div class="w-2 h-2 mt-1 bg-yellow-500 rounded-full"></div>
                    <div><div class="font-bold text-yellow-500">WAIT</div><div class="text-gray-500 leading-tight mt-1">Price is near All-Time Highs. Wait for a pullback.</div></div>
                 </div>
            </div>`;
        }

        function renderDetail() {
            const asset = state.allAssets.find(a => a.symbol === state.selectedAsset);
            if(!asset) return '';
            const analysis = calculateRiskReward(asset, state.vix);
            const pctDown = ((asset.ath - asset.price) / asset.ath) * 100;
            const chartHtml = renderCandleChartSVG(asset.candles, 800);
            const pct = Math.min(pctDown, 100);
            const gradient = 'linear-gradient(90deg, #4b5563 0%, #ef4444 50%, #22c55e 100%)';

            return `
            <div class="space-y-6 fade-in">
                <button onclick="app.setView('dashboard'); app.selectAsset(null);" class="flex items-center gap-2 text-gray-400 hover:text-white text-sm font-bold uppercase tracking-widest">
                    <i data-lucide="arrow-left" class="w-4 h-4"></i> Back to Scanner
                </button>

                <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                    <div class="lg:col-span-8 space-y-4">
                         <div class="bg-[#0e0e0e] p-6 rounded-xl border border-gray-800 flex justify-between items-end">
                            <div>
                                <h1 class="text-4xl font-bold text-white flex items-center gap-3">${asset.symbol} <span class="text-sm font-normal text-gray-500 border border-gray-700 px-2 py-0.5 rounded bg-black">${asset.type}</span></h1>
                                <p class="text-gray-400 text-sm mt-1">${asset.name}</p>
                            </div>
                            <div class="text-right">
                                <div class="text-xs text-gray-500 uppercase font-bold mb-1">Current Price</div>
                                <div class="text-5xl font-mono font-bold text-white tracking-tighter">${formatCurrency(asset.price)}</div>
                            </div>
                        </div>
                        ${chartHtml}
                    </div>
                    <div class="lg:col-span-4 space-y-4">
                        <div class="p-6 rounded-xl border-2 ${analysis.bg} ${analysis.color}">
                            <div class="flex items-center gap-2 mb-2 text-xs font-bold uppercase opacity-80"><i data-lucide="activity" class="w-4 h-4"></i> Algo Signal</div>
                            <div class="text-4xl font-black tracking-tight">${analysis.signal}</div>
                            <div class="text-sm opacity-70 mt-2">Confidence Score: ${analysis.score}/100</div>
                        </div>
                        <div class="bg-[#0e0e0e] border border-gray-800 rounded-xl p-6 space-y-6">
                            <div>
                                <h3 class="text-xs font-bold text-gray-500 uppercase mb-3 flex items-center gap-2"><i data-lucide="bar-chart-2" class="w-3 h-3"></i> Key Levels</h3>
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="bg-black p-3 rounded border border-gray-800"><div class="text-[10px] text-gray-500 uppercase mb-1">ATH</div><div class="text-white font-mono font-bold">${formatCurrency(asset.ath)}</div></div>
                                    <div class="bg-black p-3 rounded border border-gray-800"><div class="text-[10px] text-gray-500 uppercase mb-1">Market Cap</div><div class="text-white font-mono font-bold">${formatMarketCap(asset.marketCap)}</div></div>
                                </div>
                            </div>
                             <div>
                                <h3 class="text-xs font-bold text-gray-500 uppercase mb-2 flex justify-between"><span>Discount Zone</span><span class="text-white">${pctDown.toFixed(2)}% Down</span></h3>
                                <div class="w-full h-2 bg-gray-800 rounded-full overflow-hidden relative"><div class="absolute top-0 bottom-0 w-full" style="background: ${gradient}"></div><div class="absolute top-0 bottom-0 w-1 bg-white shadow-[0_0_10px_white] z-10" style="left: ${pct}%"></div></div>
                            </div>
                            <div>
                                <h3 class="text-xs font-bold text-gray-500 uppercase mb-2 flex justify-between"><span>RSI (14)</span><span class="${analysis.rsi < 30 ? 'text-green-400' : analysis.rsi > 70 ? 'text-red-400' : 'text-white'}">${analysis.rsi.toFixed(1)}</span></h3>
                                <div class="w-full h-2 bg-gray-800 rounded-full overflow-hidden relative"><div class="absolute left-0 w-[30%] h-full bg-green-900/30"></div><div class="absolute right-0 w-[30%] h-full bg-red-900/30"></div><div class="absolute top-0 h-full w-2 bg-blue-500 rounded-full transition-all duration-500" style="left: ${analysis.rsi}%"></div></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;
        }

        function renderPortfolio() {
            let totalInv = 0, totalVal = 0;
            const rows = state.portfolio.map(item => {
                const asset = state.allAssets.find(a => a.symbol === item.symbol) || { price: item.avgCost };
                const val = item.shares * asset.price;
                const pl = val - item.invested;
                const plPct = (pl / item.invested) * 100;
                totalInv += item.invested;
                totalVal += val;
                return `
                <tr class="border-b border-gray-800 hover:bg-[#111]">
                    <td class="p-4 font-bold text-white">${item.symbol}</td>
                    <td class="p-4 text-right text-gray-400 font-mono">${item.shares.toFixed(4)}</td>
                    <td class="p-4 text-right text-gray-400 font-mono">${formatCurrency(item.avgCost)}</td>
                    <td class="p-4 text-right text-white font-mono">${formatCurrency(asset.price)}</td>
                    <td class="p-4 text-right text-blue-300 font-mono">${formatCurrency(val)}</td>
                    <td class="p-4 text-right font-mono font-bold ${pl>=0?'text-green-400':'text-red-400'}">
                        ${pl>=0?'+':''}${formatCurrency(pl)} <span class="text-xs font-normal opacity-70">(${plPct.toFixed(2)}%)</span>
                    </td>
                    <td class="p-4 text-center">
                        <button onclick="app.removePortfolioItem('${item.symbol}')" class="text-red-500 hover:text-red-400"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </td>
                </tr>`;
            }).join('');

            const totalPL = totalVal - totalInv;
            const totalPLPct = totalInv > 0 ? (totalPL / totalInv) * 100 : 0;

            return `
            <div class="animate-in fade-in space-y-6">
                 <div class="flex justify-between items-end"><h2 class="text-2xl font-bold text-white">Long Term Portfolio</h2></div>
                 <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-[#0e0e0e] border border-gray-800 p-6 rounded-lg"><div class="text-gray-500 text-xs uppercase">Total Invested</div><div class="text-3xl font-mono text-white">${formatCurrency(totalInv)}</div></div>
                    <div class="bg-[#0e0e0e] border border-gray-800 p-6 rounded-lg"><div class="text-gray-500 text-xs uppercase">Current Value</div><div class="text-3xl font-mono text-blue-400">${formatCurrency(totalVal)}</div></div>
                     <div class="bg-[#0e0e0e] border border-gray-800 p-6 rounded-lg"><div class="text-gray-500 text-xs uppercase">Total P/L</div><div class="text-3xl font-mono ${totalPL>=0?'text-green-400':'text-red-400'}">${totalPL>=0?'+':''}${formatCurrency(totalPL)} (${totalPLPct.toFixed(2)}%)</div></div>
                 </div>

                 <div class="bg-[#0e0e0e] border border-gray-800 p-4 rounded-lg">
                    <h3 class="text-sm font-bold text-white mb-4 flex items-center gap-2"><i data-lucide="plus" class="w-4 h-4"></i> Add Investment (DCA)</h3>
                    <form onsubmit="app.addPortfolioItem(event)" class="flex gap-4 items-end">
                        <div class="flex-1">
                            <label class="block text-xs text-gray-500 mb-1">Asset</label>
                            <select id="portSymbol" class="w-full bg-black border border-gray-700 text-white rounded px-3 py-2 text-sm">
                                <option value="">Select...</option>
                                ${BASE_POOL.map(a => `<option value="${a.symbol}">${a.symbol} - ${a.name}</option>`).join('')}
                            </select>
                        </div>
                        <div class="flex-1">
                             <label class="block text-xs text-gray-500 mb-1">Amount ($)</label>
                             <input id="portAmount" type="number" placeholder="5000" class="w-full bg-black border border-gray-700 text-white rounded px-3 py-2 text-sm">
                        </div>
                        <button type="submit" class="px-6 py-2 bg-green-600 hover:bg-green-500 text-white text-sm font-bold rounded">Add</button>
                    </form>
                 </div>

                 <div class="overflow-x-auto bg-[#0e0e0e] border border-gray-800 rounded-lg">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="text-gray-500 text-xs uppercase border-b border-gray-800">
                                <th class="p-4">Asset</th><th class="p-4 text-right">Shares</th><th class="p-4 text-right">Avg Cost</th>
                                <th class="p-4 text-right">Price</th><th class="p-4 text-right">Value</th><th class="p-4 text-right">Return</th><th class="p-4 text-center">Action</th>
                            </tr>
                        </thead>
                        <tbody>${rows.length ? rows : '<tr><td colspan="7" class="p-8 text-center text-gray-500">No assets yet.</td></tr>'}</tbody>
                    </table>
                 </div>
            </div>`;
        }

        function renderHeader() {
             // (No major logic changes, just visual update status)
             return ''; // Rendered static in HTML body, updated via DOM manipulation in render()
        }

        // --- APP CONTROLLER ---
        const app = {
            setView: (v) => {
                state.view = v;
                document.getElementById('nav-dashboard').className = `px-4 py-1.5 rounded text-xs font-bold transition-all ${v === 'dashboard' ? 'bg-gray-800 text-white' : 'text-gray-500 hover:text-white'}`;
                document.getElementById('nav-portfolio').className = `px-4 py-1.5 rounded text-xs font-bold transition-all ${v === 'portfolio' ? 'bg-gray-800 text-white' : 'text-gray-500 hover:text-white'}`;
                render();
            },
            setSort: (key) => {
                let direction = 'asc';
                if (state.sortConfig.key === key && state.sortConfig.direction === 'asc') direction = 'desc';
                updateState({ sortConfig: { key, direction } });
            },
            setStrategy: (s) => updateState({ strategy: s }),
            selectAsset: (s) => {
                state.selectedAsset = s;
                state.view = 'detail';
                render();
            },
            handleRefresh: fetchData, 
            addPortfolioItem: (e) => {
                e.preventDefault();
                const sym = document.getElementById('portSymbol').value;
                const amt = parseFloat(document.getElementById('portAmount').value);
                if(!sym || !amt) return;
                
                const asset = state.allAssets.find(a => a.symbol === sym);
                if(!asset) { alert("Asset error"); return; }
                
                const price = asset.price;
                const shares = amt / price;
                
                const existing = state.portfolio.find(p => p.symbol === sym);
                let newPort = [];
                if(existing) {
                    newPort = state.portfolio.map(p => p.symbol === sym ? { ...p, shares: p.shares + shares, invested: p.invested + amt, avgCost: (p.invested + amt)/(p.shares+shares) } : p);
                } else {
                    newPort = [...state.portfolio, { symbol: sym, shares, invested: amt, avgCost: price }];
                }
                
                localStorage.setItem('proTraderPortfolio', JSON.stringify(newPort));
                state.portfolio = newPort;
                render();
            },
            removePortfolioItem: (sym) => {
                if(!confirm('Remove this position?')) return;
                const newPort = state.portfolio.filter(p => p.symbol !== sym);
                localStorage.setItem('proTraderPortfolio', JSON.stringify(newPort));
                state.portfolio = newPort;
                render();
            }
        };

        window.app = app;

        function render() {
            const root = document.getElementById('root');
            
            document.getElementById('last-updated').innerText = state.lastUpdated.toLocaleTimeString();
            const refreshBtn = document.getElementById('refresh-btn');
            const refreshText = document.getElementById('refresh-text');
            const apiStatus = document.getElementById('api-status');
            
            if (state.isRefreshing) {
                refreshBtn.classList.add('opacity-70', 'cursor-not-allowed');
                refreshBtn.querySelector('i').classList.add('spin-slow');
                refreshText.innerText = 'FETCHING...';
                apiStatus.innerText = 'CONNECTING...';
                apiStatus.className = 'text-yellow-500';
            } else {
                refreshBtn.classList.remove('opacity-70', 'cursor-not-allowed');
                refreshBtn.querySelector('i').classList.remove('spin-slow');
                refreshText.innerText = 'REFRESH DATA';
                
                if (state.apiStatus.includes('ONLINE')) apiStatus.className = 'text-green-500';
                else if (state.apiStatus.includes('OFFLINE')) apiStatus.className = 'text-orange-500';
                else apiStatus.className = 'text-red-500';
                
                apiStatus.innerText = state.apiStatus.toUpperCase();
            }

            let content = '';
            if (state.view === 'dashboard') content = renderDashboard();
            else if (state.view === 'detail') content = renderDetail();
            else if (state.view === 'portfolio') content = renderPortfolio();
            
            root.innerHTML = content;
            if(window.lucide) window.lucide.createIcons();
        }

        init();

    </script>
</body>
</html>
